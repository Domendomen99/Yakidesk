/**
 * Core Philosophy: This ruleset uses a mixed-privacy model.
 * - Publicly readable, privately writable data: User profiles and bookings are readable
 *   by any authenticated user to facilitate UI features (like showing who booked a desk),
 *   but can only be created, updated, or deleted by the user who owns them.
 * - Admin-managed data: Desk information is read-only for all clients.
 *
 * Data Structure:
 * - /users/{userId}: Publicly readable user profiles.
 * - /bookings/{bookingId}: Publicly readable list of all bookings.
 * - /desks/{deskId}: Publicly readable desk information.
 *
 * Key Security Decisions:
 * - Path-Based Security & Field Validation: Rules rely on the `{userId}` wildcard and
 *   validating the `userId` field within documents to grant write access. This is
 *   performant and secure.
 * - User Profile Management: Users create their own profile upon their first booking action.
 *   They can update their own profile, but cannot change their ID. Other users can read profiles
 *   but cannot write to them.
 * - Booking Management: Any authenticated user can read the list of bookings. However,
 *   a user can only create, update, or delete bookings where the `userId` field
 *   matches their own `request.auth.uid`.
 * - Admin-Managed Desks: The `/desks` collection is strictly read-only for clients.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    //-------------------------------------------------------------------------
    // Collection Rules
    //-------------------------------------------------------------------------

    /**
     * @description Manages user profiles. Profiles are readable by any authenticated user
     *   to display information like names on bookings, but are only writable by the owner.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId);
    }

    /**
     * @description Manages the collection of available desks. This data is public
     *   read-only for all clients.
     * @path /desks/{deskId}
     */
    match /desks/{deskId} {
      allow read: if true;
      allow write: if false; // Must be managed from a trusted server environment
    }

    /**
     * @description Manages all bookings. Bookings are readable by all authenticated users,
     *   but can only be created or deleted by the user who owns the booking.
     * @path /bookings/{bookingId}
     */
    match /bookings/{bookingId} {
      allow read: if isSignedIn();
      // Allow create if the user is signed in and the booking's userId matches their own.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      // Allow update/delete if the user is signed in and the existing booking's userId matches their own.
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}
